<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ver SR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .tag-green { background:#4CAF50; color:white; padding:4px 8px; border-radius:4px; }
        .tag-yellow { background:#FFC107; color:black; padding:4px 8px; border-radius:4px; }
        .tag-red { background:#DC3545; color:white; padding:4px 8px; border-radius:4px; }
    </style>
</head>

<body class="p-4">

<h2>Listado de SR</h2>
<hr>

<!-- FILTROS -->
<form method="GET" class="row g-3 mb-4">

    <div class="col-md-3">
        <input type="text" name="q" class="form-control"
               placeholder="Buscar OT / cliente / producto" value="{{ query }}">
    </div>

    <div class="col-md-2">
        <select name="estado" class="form-control">
            <option value="">Estado</option>
            <option {% if estado == "abierto" %}selected{% endif %}>abierto</option>
            <option {% if estado == "en proceso" %}selected{% endif %}>en proceso</option>
            <option {% if estado == "cerrado" %}selected{% endif %}>cerrado</option>
        </select>
    </div>

    <div class="col-md-2">
        <input type="text" name="cliente" class="form-control"
               placeholder="Cliente" value="{{ cliente }}">
    </div>

    <div class="col-md-2">
        <input type="text" name="producto" class="form-control"
               placeholder="Producto" value="{{ producto }}">
    </div>

    <div class="col-md-2">
        <input type="text" name="ing" class="form-control"
               placeholder="Ing encargado" value="{{ ing }}">
    </div>

    <div class="col-md-2">
        <label>Desde:</label>
        <input type="date" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
    </div>

    <div class="col-md-2">
        <label>Hasta:</label>
        <input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
    </div>

    <div class="col-md-12">
        <button class="btn btn-primary">Aplicar filtros</button>
    </div>
</form>

<!-- TABLA -->
<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>OT</th>
            <th>Cliente</th>
            <th>Producto</th>
            <th>Fecha ingreso</th>
            <th>Días cola</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>

    <tbody>
    {% for ot in ots %}
        <tr>
            <td>
                {{ ot.ot }}
                {% if ot.fecha_estimada %}
                    <span class="text-warning" title="Fecha estimada">⚠</span>
                {% endif %}
            </td>

            <td>{{ ot.cliente }}</td>
            <td>{{ ot.producto }}</td>
            <td>{{ ot.fecha_ingreso|date:"d/m/Y" }}</td>

            <td>
                {% if ot.color == "green" %}
                    <span class="tag-green">{{ ot.dias }}</span>
                {% elif ot.color == "yellow" %}
                    <span class="tag-yellow">{{ ot.dias }}</span>
                {% else %}
                    <span class="tag-red">{{ ot.dias }}</span>
                {% endif %}
            </td>

            <td>{{ ot.estado }}</td>

            <td>
                <!-- MÁS INFO SIEMPRE DISPONIBLE -->
                <a href="{% url 'detalle_sr' ot.id %}" class="btn btn-primary btn-sm">Más info</a>

                <!-- EDITAR SOLO ADMIN / ING -->
                {% if user.rol != "cliente" %}
                <a href="{% url 'editar_sr' ot.id %}" class="btn btn-warning btn-sm">Editar</a>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- PAGINACIÓN -->
<nav aria-label="Page navigation">
  <ul class="pagination">

    {% if ots.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ ots.previous_page_number }}">Anterior</a>
      </li>
    {% endif %}

    <li class="page-item active">
      <span class="page-link">
        Página {{ ots.number }} de {{ ots.paginator.num_pages }}
      </span>
    </li>

    {% if ots.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ ots.next_page_number }}">Siguiente</a>
      </li>
    {% endif %}

  </ul>
</nav>

<!-- BOTÓN FLOTANTE REGRESAR -->
<a href="/" 
   class="btn btn-secondary shadow-lg"
   style="
       position: fixed;
       bottom: 20px;
       right: 20px;
       z-index: 1000;
       border-radius: 50px;
       padding: 10px 18px;
   ">
    Regresar
</a>

</body>
</html>
