<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gr√°ficas de rendimiento</title>

    {% load static %}

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Estilos propios -->
    <link rel="stylesheet" href="{% static 'css/graficas.css' %}">

    <!-- Chart.js para KPIs globales -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Plotly para las gr√°ficas tipo PDF -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>

<body class="p-4">

<h2>Gr√°ficas de rendimiento</h2>
<hr>

<!-- FILTROS -->
<form method="GET" class="row g-3 mb-4">
    <div class="col-md-3">
        <label>Fecha inicio</label>
        <input type="date" name="fecha_inicio" class="form-control" value="{{ fecha_inicio }}">
    </div>
    <div class="col-md-3">
        <label>Fecha fin</label>
        <input type="date" name="fecha_fin" class="form-control" value="{{ fecha_fin }}">
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-primary w-100">Aplicar filtros</button>
    </div>
    <div class="col-md-3 d-flex align-items-end">
        <a href="{% url 'exportar_kpis_excel' %}?fecha_inicio={{ fecha_inicio }}&fecha_fin={{ fecha_fin }}"
           class="btn btn-success w-100">
            Exportar Excel
        </a>
    </div>
</form>

<!-- KPIs globales resumen -->
<div class="alert alert-info">
    <strong>Resumen:</strong>
    OTs cerradas: {{ globales.total_ot_cerradas }} |
    MTTI promedio: {{ globales.mtti_promedio }} d√≠as h√°biles
</div>

<!-- TABS -->
<ul class="nav nav-tabs" id="kpiTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="globales-tab" data-bs-toggle="tab"
                data-bs-target="#tab-globales" type="button" role="tab">
            KPIs globales
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="mtti-tab" data-bs-toggle="tab"
                data-bs-target="#tab-mtti" type="button" role="tab">
            Distribuci√≥n MTTI por familia
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="segmentos-tab" data-bs-toggle="tab"
                data-bs-target="#tab-segmentos" type="button" role="tab">
            Atenci√≥n por segmento comercial
        </button>
    </li>
</ul>

<div class="tab-content" id="kpiTabsContent">

    <!-- ================= TAB 1: KPIs GLOBALES (Chart.js) ================= -->
    <div class="tab-pane fade show active" id="tab-globales" role="tabpanel" aria-labelledby="globales-tab">

        <div class="row mt-3">
            <div class="col-md-6 mb-4">
                <h5>OTs cerradas por familia</h5>
                <canvas id="chart_familias"></canvas>
            </div>
            <div class="col-md-6 mb-4">
                <h5>MTTI promedio por familia</h5>
                <canvas id="chart_mtti_familias"></canvas>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <h5>OTs cerradas por segmento</h5>
                <canvas id="chart_segmentos"></canvas>
            </div>
            <div class="col-md-6 mb-4">
                <h5>MTTI promedio por segmento</h5>
                <canvas id="chart_mtti_segmentos"></canvas>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 mb-4">
                <h5>Cierres por mes</h5>
                <canvas id="chart_cierres"></canvas>
            </div>
        </div>
    </div>

    <!-- ================= TAB 2: MTTI POR FAMILIA (KPI + Plotly) ================= -->
    <div class="tab-pane fade" id="tab-mtti" role="tabpanel" aria-labelledby="mtti-tab">

        <!-- Tablitas KPI tipo PDF (por familia, periodo filtrado) -->
        <h5 class="mt-3 mb-2">Resumen por familia (periodo seleccionado)</h5>
        <div class="row g-3 mb-4" id="kpi_familias_row">
            <!-- Se llena desde JS con familiasData -->
        </div>

        <!-- üîµ Aqu√≠ luego podemos meter la tabla de Q1/Q2/Q3/Q4/Wxx/Acumulado/Cierre
             usando los periodos que definiste, cuando tengamos los datos desde la vista. -->

        <!-- Histograma por familia -->
        <h5 class="mt-4 mb-3">Histograma MTTI por familia (0‚Äì8, 9‚Äì16, 17‚Äì20, &gt;20 d√≠as)</h5>

        <div class="hist-grid">
            <div class="hist-box">
                <div class="hist-title">CLOUD</div>
                <div id="hist_CLOUD"></div>
            </div>
            <div class="hist-box">
                <div class="hist-title">CIBER</div>
                <div id="hist_CIBER"></div>
            </div>
            <div class="hist-box">
                <div class="hist-title">FIJO</div>
                <div id="hist_FIJO"></div>
            </div>
            <div class="hist-box">
                <div class="hist-title">SDWAN</div>
                <div id="hist_SDWAN"></div>
            </div>
            <div class="hist-box">
                <div class="hist-title">UCASS</div>
                <div id="hist_UCASS"></div>
            </div>
            <div class="hist-box">
                <div class="hist-title">VAS</div>
                <div id="hist_VAS"></div>
            </div>
        </div>

    </div>

    <!-- ========== TAB 3: ATENCI√ìN √ìRDENES POR SEGMENTO (Plotly) ========== -->
    <div class="tab-pane fade" id="tab-segmentos" role="tabpanel" aria-labelledby="segmentos-tab">

        <h5 class="mt-3 mb-3">Atenci√≥n √≥rdenes por segmento comercial</h5>

        <!-- AHORA UNA DEBAJO DE OTRA, COMO LOS HISTOGRAMAS -->
        <div class="segment-grid">
            <div class="segment-box">
                <div class="segment-title">MNC</div>
                <div id="seg_MNC"></div>
            </div>
            <div class="segment-box">
                <div class="segment-title">GOVERNMENT</div>
                <div id="seg_GOVERNMENT"></div>
            </div>
            <div class="segment-box">
                <div class="segment-title">ENTERPRISE</div>
                <div id="seg_ENTERPRISE"></div>
            </div>
            <div class="segment-box">
                <div class="segment-title">LARGE</div>
                <div id="seg_LARGE"></div>
            </div>
            <div class="segment-box">
                <div class="segment-title">SMALL</div>
                <div id="seg_SMALL"></div>
            </div>
            <div class="segment-box">
                <div class="segment-title">WHOLESALE</div>
                <div id="seg_WHOLESALE"></div>
            </div>
        </div>

    </div>
</div>

<!-- Bot√≥n regresar flotante -->
<a href="/"
   class="btn btn-secondary shadow-lg btn-regresar">
    Regresar
</a>

<!-- Bootstrap JS para tabs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // =================== DATOS DESDE DJANGO ===================
    const familiasData     = JSON.parse('{{ familias_json|escapejs }}');
    const segmentosData    = JSON.parse('{{ segmentos_json|escapejs }}');
    const cierresData      = JSON.parse('{{ cierres_json|escapejs }}');
    const histFamilias     = JSON.parse('{{ hist_familias_json|escapejs }}');
    const segComercialData = JSON.parse('{{ seg_comercial_json|escapejs }}');

    // =================== TAB 1: KPIs GLOBALES (Chart.js) ===================

    const familyColors = {
        "CLOUD": "#0070C0",
        "CIBER": "#00B0F0",
        "FIJO":  "#00B050",
        "SDWAN": "#C00000",
        "UCASS": "#7030A0",
        "VAS":   "#808080",
    };

    // -- OTs por familia --
    const famLabels = familiasData.map(f => f.familia);
    const famTotals = familiasData.map(f => f.total);
    const famMtti   = familiasData.map(f => f.mtti_promedio);

    new Chart(
        document.getElementById('chart_familias'),
        {
            type: 'bar',
            data: {
                labels: famLabels,
                datasets: [{
                    label: 'OTs cerradas',
                    data: famTotals,
                    backgroundColor: famLabels.map(l => familyColors[l] || '#999999')
                }]
            },
            options: { responsive: true }
        }
    );

    new Chart(
        document.getElementById('chart_mtti_familias'),
        {
            type: 'bar',
            data: {
                labels: famLabels,
                datasets: [{
                    label: 'MTTI (d√≠as h√°biles)',
                    data: famMtti,
                    backgroundColor: famLabels.map(l => familyColors[l] || '#999999')
                }]
            },
            options: { responsive: true }
        }
    );

    // -- Segmentos --
    const segLabels = segmentosData.map(s => s.segmento);
    const segTotals = segmentosData.map(s => s.total);
    const segMtti   = segmentosData.map(s => s.mtti_promedio);

    new Chart(
        document.getElementById('chart_segmentos'),
        {
            type: 'bar',
            data: {
                labels: segLabels,
                datasets: [{
                    label: 'OTs cerradas',
                    data: segTotals,
                    backgroundColor: '#4E79A7'
                }]
            },
            options: { responsive: true }
        }
    );

    new Chart(
        document.getElementById('chart_mtti_segmentos'),
        {
            type: 'bar',
            data: {
                labels: segLabels,
                datasets: [{
                    label: 'MTTI (d√≠as h√°biles)',
                    data: segMtti,
                    backgroundColor: '#F28E2B'
                }]
            },
            options: { responsive: true }
        }
    );

    // -- Cierres por mes --
    const cierresLabels = cierresData.map(c => c.periodo);
    const cierresTotals = cierresData.map(c => c.total);

    new Chart(
        document.getElementById('chart_cierres'),
        {
            type: 'line',
            data: {
                labels: cierresLabels,
                datasets: [{
                    label: 'OTs cerradas',
                    data: cierresTotals,
                    fill: false,
                    tension: 0.1
                }]
            },
            options: { responsive: true }
        }
    );

    // =================== TAB 2: KPI + HISTOGRAMA MTTI POR FAMILIA ===================

    // Tablitas KPI por familia (periodo filtrado)
    const kpiRow = document.getElementById('kpi_familias_row');

    const familiaCss = {
        'CLOUD': 'kpi-cloud',
        'CIBER': 'kpi-ciber',
        'FIJO': 'kpi-fijo',
        'SDWAN': 'kpi-sdwan',
        'UCASS': 'kpi-ucass',
        'VAS': 'kpi-vas',
    };

    familiasData.forEach(f => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-2';

        const card = document.createElement('div');
        const css  = familiaCss[f.familia] || 'kpi-cloud';
        const mtti = (typeof f.mtti_promedio === "number")
            ? f.mtti_promedio.toFixed(1)
            : f.mtti_promedio;

        card.className = `kpi-card-familia ${css}`;
        card.innerHTML = `
            <div class="kpi-card-label">${f.familia}</div>
            <div class="kpi-card-valor">${f.total} OT's</div>
            <div class="kpi-card-mtti">${mtti} D</div>
        `;

        col.appendChild(card);
        kpiRow.appendChild(col);
    });

    // Histogramas MTTI por familia (Plotly)
    function dibujarHistogramaFamilia(familiaCode) {
        const fila = histFamilias.find(h => h.familia === familiaCode);
        if (!fila) return;

        const x = fila.bins;        // ["0-8","9-16","17-20",">20"]
        const y = fila.valores;     // [51,56,11,7]

        const data = [{
            x: x,
            y: y,
            type: 'bar',
            marker: { color: '#005f7f' },
            text: y.map(v => v === 0 ? '' : v),
            textposition: 'outside'
        }];

        const layout = {
            margin: {l: 30, r: 10, t: 10, b: 40},
            height: 260,
            xaxis: { title: '', tickfont: { size: 10 } },
            yaxis: { title: '', showgrid: false, zeroline: false }
        };

        Plotly.newPlot('hist_' + familiaCode, data, layout, {displayModeBar: false});
    }

    ['CLOUD', 'CIBER', 'FIJO', 'SDWAN', 'UCASS', 'VAS'].forEach(dibujarHistogramaFamilia);

    // =================== TAB 3: ATENCI√ìN POR SEGMENTO (Plotly) ===================

    function dibujarSegmento(segCode) {
        const seg = segComercialData.find(s => s.segmento === segCode);
        if (!seg) return;

        const x    = seg.familias;  // ["CIBER","CLOUD",...]
        const sr   = seg.sr;
        const mtti = seg.mtti;

        const traceBars = {
            x: x,
            y: sr,
            type: 'bar',
            name: 'SR',
            marker: { color: '#002060' },
            yaxis: 'y1'
        };

        const traceLine = {
            x: x,
            y: mtti,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'MTTI',
            marker: { color: '#00B0F0' },
            line: { shape: 'spline' },
            yaxis: 'y2'
        };

        const layout = {
            margin: {l: 40, r: 40, t: 10, b: 40},
            height: 260,
            xaxis: { tickfont: { size: 10 } },
            yaxis: {
                title: 'SR',
                rangemode: 'tozero'
            },
            yaxis2: {
                title: 'MTTI',
                overlaying: 'y',
                side: 'right',
                rangemode: 'tozero'
            },
            legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.25 }
        };

        Plotly.newPlot('seg_' + segCode, [traceBars, traceLine], layout, {displayModeBar: false});
    }

    ['MNC', 'GOVERNMENT', 'ENTERPRISE', 'LARGE', 'SMALL', 'WHOLESALE'].forEach(dibujarSegmento);
</script>

</body>
</html>
